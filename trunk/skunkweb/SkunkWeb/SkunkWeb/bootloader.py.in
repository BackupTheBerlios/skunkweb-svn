# -*-python-*-
# $Id: bootloader.py.in,v 1.7 2003/04/13 03:35:34 smulloni Exp $
# Time-stamp: <03/04/12 23:13:51 smulloni>
#  
#  Copyright (C) 2001 Andrew T. Csillag <drew_csillag@geocities.com>
#  
#      This program is free software; you can redistribute it and/or modify
#      it under the terms of the GNU General Public License as published by
#      the Free Software Foundation; either version 2 of the License, or
#      (at your option) any later version.
#  
#      This program is distributed in the hope that it will be useful,
#      but WITHOUT ANY WARRANTY; without even the implied warranty of
#      MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#      GNU General Public License for more details.
#  
#      You should have received a copy of the GNU General Public License
#      along with this program; if not, write to the Free Software
#      Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111, USA.
#   
########################################################################
import confvars as _c
SkunkRoot = _c.SKUNK_ROOT
DEFAULT_CONFIG_FILE_NAME = _c.DEFAULT_CONFIG_FILE_NAME

_servicesRoot = _c.SERVICES_ROOT
_pylibsRoot = _c.PYLIBS_ROOT

#handle if we've not been run through configure
if DEFAULT_CONFIG_FILE_NAME[0] == '@': #not populated by configure
    DEFAULT_CONFIG_FILE_NAME = 'sw.conf'

if SkunkRoot[0] == '@':
    SkunkRoot = '/usr/local/skunk'

def init(configFiles, SkunkRoot):
    # necessary for restart
    import vfs; vfs.importer.uninstall()
    import ConfigLoader
    import KickStart
    #get the configuration module
    from SkunkWeb import Configuration
    #set default for skunkroot, runInForeground
    Configuration.mergeDefaults(SkunkRoot = SkunkRoot, 
                                runInForeground = 0)

    #do stupid function to import modules so our module snapshot will be
    #complete since we have to grab it before the configuration is loaded
    #but would otherwise have to import SkunkWeb.Server to get everything
    def _stupidfunc():
        import sys
        import Logger, traceback, signal, LogObj, pwd, grp
        from SocketMan.SocketMan import SocketMan
        mods = sys.modules.keys() + ['SkunkWeb.Server']
        mods.sort()
        return mods
    
    mods = _stupidfunc()

    #load config files
    for c in configFiles:
        ConfigLoader.loadConfigFile(c, KickStart.CONFIG_MODULE)

    Configuration.mergeDefaults(_config_files_ = configFiles,
                                SkunkWebVersion = _c.SKUNKWEB_VERSION)
    return mods

def load():
    from SkunkWeb import Configuration, LogObj, ServiceRegistry, Hooks 
    for serviceName in Configuration.services:
	LogObj.LOG("Loading service %s" % serviceName)
	__import__(serviceName)
    ServiceRegistry.debugRegisteredServices(Configuration.initialDebugServices)
    Hooks.ServerStart()


import pprint
from formlib import *
from formlib.form import CompositeField
from formlib.views import TextField, SubmitField, ViewableForm, ViewableCompositeField, isviewable, ViewableFieldProxy 

addr1 = TextField('1', description="Address 1", default="default", size="20", maxlength="39", required=1)
addrpst = TextField('postal', description="Postal Code", default=None, size="20", required=1)
sbmtFld = SubmitField("submit", default="Submit Thyself", description="SubmitField")

flds = [ addr1, addrpst, sbmtFld ]
prxyflds = [ViewableFieldProxy('addrproxy', addr1), ViewableFieldProxy('addrpstproxy', addrpst), ViewableFieldProxy('sbmtFldproxy', sbmtFld)]

cmpFld = ViewableCompositeField('composite', description='Address Composite Field', componentFields=flds, setable=1)

def validate(form):
    pass

form = ViewableForm(name="testAllViews", method="POST", fields=[cmpFld], validators=[validate])
form2 = ViewableForm(name="test2", method="POST", fields=prxyflds, validators=[validate])

print 'COMPOSITE FORM INTERNALS<br/>'
cmpFld = form.fields['composite']
print 'keys:', form.fields.keys(), '<br />'
print 'COMPOSITE FIELD IS A COMPOSITE FIELD:', isinstance(cmpFld, CompositeField)
print '<br />COMPOSITE IS SETABLE:', cmpFld.setable, '<br />'
print 'COMPOSITE FIELDS:', [fld.name for fld in cmpFld.fields], '<br />'
for fld in cmpFld.fields:
    print fld.name, '[default:', fld.default, '][value:', fld.value, '][IS FieldProxy:', isinstance(fld, FieldProxy), \
          '][IS viewable:', isviewable(fld), '][IS setable:', fld.setable, ']'
    print '<br />'

print '<hr/>'

import ecs
if CONNECTION.method == "POST":
    print "<hr />CONNECTION ARGS:%s<hr />" % (str(CONNECTION.args))

    form.submit(CONNECTION.args)
    print ecs.H4('composite form data')
    print ecs.Pre(pprint.pformat(form.getData()))
    print

    if form.errors:
        print ecs.H4('form errors')
        print ecs.Pre(pprint.pformat([(x.field.name, x.errormsg) for x in form.errors]))
        print
        
        print ecs.H3("ERROR")
    else:
        print ecs.H3("Successful form submission.  Values were:")
        for fld in form.fields:
            print "%s -> %s:%s" % (fld.description, fld.name, fld.value)
            print ecs.Br()
        print ecs.Hr()

print ecs.Hr()
print form.getView()    
